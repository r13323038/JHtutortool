# 📝 GitHub ➜ Cloud Run 自動部署流程筆記

這是一份整理好的部署筆記，幫助我記錄如何使用 Git + GitHub + Cloud Run 自動部署 LINE Bot 專案。

---

## 📦 專案架構

```
JHtutortool/
├── main.py
├── line_bot.py
├── search_knowledge.py
├── prompt_engine.py
├── chatgpt_api.py
├── requirements.txt
├── Dockerfile
├── cloudbuild.yaml ✅
├── .gitignore ✅
└── .env ❌（不應加入 Git）
```

---

## 🔁 日常部署流程（開發 ➜ 上線）

```bash
# 1️⃣ 進入專案資料夾
cd ~/JHtutortool

# 2️⃣ 查看目前檔案狀態（非必須）
git status

# 3️⃣ 加入所有變更
git add .

# 4️⃣ 建立 commit（描述這次修改）
git commit -m "描述這次修改，例如：新增 ping 路由"

# 5️⃣ 推送到 GitHub，觸發部署
git push
```

✔️ 完成後 Cloud Build Trigger 將會：

* 偵測 push
* 使用 cloudbuild.yaml build & deploy
* 自動更新 Cloud Run 上線版本

---

## ⚙️ cloudbuild.yaml 樣板

```yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/line-bot-app', '.' ]

  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', 'gcr.io/$PROJECT_ID/line-bot-app' ]

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      [
        'run',
        'deploy',
        'line-bot-app',
        '--image',
        'gcr.io/$PROJECT_ID/line-bot-app',
        '--region',
        'asia-east1',
        '--platform',
        'managed',
        '--allow-unauthenticated',
        '--set-env-vars',
        'LINE_CHANNEL_ACCESS_TOKEN=$_LINE_CHANNEL_ACCESS_TOKEN,LINE_CHANNEL_SECRET=$_LINE_CHANNEL_SECRET,OPENAI_API_KEY=$_OPENAI_API_KEY'
      ]

options:
  logging: CLOUD_LOGGING_ONLY
```

---

## 🔐 Substitution Variables 設定建議（Trigger 中設定）

```text
_LINE_CHANNEL_ACCESS_TOKEN=xxxxx
_LINE_CHANNEL_SECRET=xxxxx
_OPENAI_API_KEY=sk-xxxxx
```

---

## ✅ 完整一條龍部署成功條件

| 條件                           | 是否需要                |
| :--------------------------- | :------------------ |
| `cloudbuild.yaml`            | ✅ 必須，有完整步驟          |
| Dockerfile                   | ✅ 必須，提供 build 基底    |
| GitHub Repo 連結 Trigger       | ✅ 必須                |
| Git Push 到 main branch       | ✅ 必須觸發部署            |
| 設定環境變數於 Trigger（或 Cloud Run） | ✅ 建議使用 Substitution |

---

## 🧠 備註

* Cloud Run 的新版會覆蓋舊版，但不會保留舊的環境變數
* 所有變更都應使用 commit 做說明，方便未來回溯
* `.env` 不應推上 Git（記得加進 .gitignore）

---

🧠 本文件可當作部署參考，或 README 使用！
